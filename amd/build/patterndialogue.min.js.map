{"version":3,"file":"patterndialogue.min.js","sources":["../src/patterndialogue.js"],"sourcesContent":["/* eslint-disable no-unused-vars */\n// This file is part of Moodle - http:// Moodle.org/.\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @module     mod_datalynx/patterndialogue\n * @copyright  2025 Wunderbyte GmbH\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Str from 'core/str';\n\nclass PatternDialogue {\n    constructor(options) {\n        this.options = options;\n        this.dialogInstances = new Map();\n    }\n\n    init() {\n        console.log(this.options);\n        document.addEventListener('DOMContentLoaded', () => {\n            this.waitForTinyMCE();\n\n            const dropdownMenu = document.getElementById('eparam2_editor_field_tag_menu');\n            if (dropdownMenu) {\n                dropdownMenu.addEventListener('change', () => this.insertTagFromDropdown(dropdownMenu));\n            }\n\n            const form = document.querySelector('#datalynx-view-edit-form');\n            form?.addEventListener('submit', (e) => this.convertButtonsToTagsBeforeSubmit());\n        });\n    }\n\n    replaceTagsWithButtons(editor) {\n        const div = document.createElement('div');\n        div.innerHTML = editor.getContent();\n\n        div.innerHTML = div.innerHTML\n            .replace(/##([^#]+)##/g, (_, action) =>\n                `<button type=\"button\" contenteditable=\"false\" data-action-tag-button=\"true\"\n                data-datalynx-field=\"${action}\">${action}</button>`\n            )\n            .replace(/\\[\\[([^\\|\\]]+)(?:\\|([^\\|\\]]*))?(?:\\|([^\\|\\]]*))?\\]\\]/g,\n                (_, field, behavior = '', renderer = '') =>\n                    `<button type=\"button\" contenteditable=\"false\" class=\"datalynx-field-tag\"\n                data-datalynx-field=\"${field}\" data-datalynx-behavior=\"${behavior}\"\n                data-datalynx-renderer=\"${renderer}\">${field}</button>`\n            );\n\n        editor.setContent(div.innerHTML);\n    }\n\n    reInitializeButtons(editor) {\n        let dataid = 0;\n        editor.getBody().querySelectorAll('button[data-action-tag-button], button.datalynx-field-tag').forEach((button) => {\n            if (!button.getAttribute('data-click-initialized')) {\n                button.addEventListener('click', () => this.openMoodleDialog(button));\n                button.setAttribute('data-click-initialized', 'true');\n                button.setAttribute('data-id', `datalynx-button-id-${dataid++}`);\n            }\n        });\n    }\n\n    initializeTinyMCEButtons() {\n        if (!window.tinyMCE?.get) {\n            return;\n        }\n\n        window.tinyMCE.get().forEach((editor) => {\n            editor.on('init', () => this.reInitializeButtons(editor));\n            editor.on('SetContent', () => this.reInitializeButtons(editor));\n            editor.on('change', () => this.reInitializeButtons(editor));\n        });\n    }\n\n    openMoodleDialog(button) {\n        const isFieldTag = button.classList.contains('datalynx-field-tag');\n        const dialogContent = document.createElement('div');\n        dialogContent.id = button.getAttribute('data-id');\n\n        if (isFieldTag) {\n            dialogContent.innerHTML = `\n                <p>Field tag properties:</p>\n                <p>Field: ${button.textContent}</p>\n                <label>Behavior:</label>\n                <select id=\"tag-behavior-select-${dialogContent.id}\">\n                    <option value=\"behavior1\">Behavior 1</option>\n                    <option value=\"behavior2\">Behavior 2</option>\n                </select>\n                <label>Renderer:</label>\n                <select id=\"tag-renderer-select-${dialogContent.id}\">\n                    <option value=\"renderer1\">Renderer 1</option>\n                    <option value=\"renderer2\">Renderer 2</option>\n                </select>\n                <button type=\"button\" class=\"delete-tag\">Delete tag</button>\n            `;\n        } else {\n            dialogContent.innerHTML = `\n                <p>Action tag properties:</p>\n                <p>Action: ${button.textContent}</p>\n                <button type=\"button\" class=\"delete-tag\">Delete tag</button>\n            `;\n        }\n\n        dialogContent.querySelectorAll('.delete-tag').forEach((delBtn) =>\n            delBtn.addEventListener('click', () => {\n                button.remove();\n                dialog?.hide();\n            })\n        );\n\n        const dialog = new M.core.dialogue({\n            bodyContent: dialogContent,\n            width: '400px',\n            draggable: true,\n            modal: true,\n            visible: true,\n        });\n\n        this.dialogInstances.set(dialogContent.id, dialog);\n    }\n\n    waitForTinyMCE() {\n        if (window.tinyMCE?.activeEditor && window.tinyMCE.get().length > 0) {\n            this.initReplaceTagsWithButtons();\n            this.initializeTinyMCEButtons();\n        } else {\n            setTimeout(() => this.waitForTinyMCE(), 100);\n        }\n    }\n\n    initReplaceTagsWithButtons() {\n        window.tinyMCE.get().forEach((editor) => {\n            editor.on('init', () => this.replaceTagsWithButtons(editor));\n            editor.on('SetContent', () => this.reInitializeButtons(editor));\n            editor.on('change', () => this.reInitializeButtons(editor));\n        });\n    }\n\n    insertTagFromDropdown(dropdown) {\n        const selectedValue = dropdown.value;\n        const actionTagMatch = selectedValue.match(/^##(.+?)##$/);\n        const fieldTagMatch = selectedValue.match(/^\\[\\[([^\\|\\]]+)(?:\\|([^\\|\\]]*))?(?:\\|([^\\|\\]]*))?\\]\\]$/);\n        let contentToInsert = '';\n\n        if (actionTagMatch) {\n            contentToInsert = `<button type=\"button\" contenteditable=\"false\" class=\"action-tag-button\"\n                data-action-tag-button=\"true\" data-datalynx-field=\"${actionTagMatch[1]}\">${actionTagMatch[1]}</button>`;\n        } else if (fieldTagMatch) {\n            const field = fieldTagMatch[1];\n            const behavior = fieldTagMatch[2] || '';\n            const renderer = fieldTagMatch[3] || '';\n            contentToInsert = `<button type=\"button\" contenteditable=\"false\" class=\"datalynx-field-tag\"\n                data-datalynx-field=\"${field}\" data-datalynx-behavior=\"${behavior}\"\n                data-datalynx-renderer=\"${renderer}\">${field}</button>`;\n        } else {\n            contentToInsert = selectedValue;\n        }\n\n        window.tinyMCE.get().forEach((editor) => {\n            if (editor.id === \"id_eparam2_editor\") {\n                editor.insertContent(contentToInsert);\n                this.reInitializeButtons(editor);\n            }\n        });\n    }\n\n    convertButtonsToTagsBeforeSubmit() {\n        window.tinyMCE.get().forEach((editor) => {\n            const div = document.createElement('div');\n            div.innerHTML = editor.getContent();\n\n            div.querySelectorAll('button[data-action-tag-button]').forEach((button) => {\n                button.replaceWith(`##${button.getAttribute('data-datalynx-field')}##`);\n            });\n\n            div.querySelectorAll('button.datalynx-field-tag').forEach((button) => {\n                const field = button.getAttribute('data-datalynx-field')?.trim();\n                const behavior = button.getAttribute('data-datalynx-behavior') || '';\n                const renderer = button.getAttribute('data-datalynx-renderer') || '';\n                const rawFieldTag = `[[${field}${behavior ? '|' + behavior : ''}${renderer ? '|' + renderer : ''}]]`;\n                button.replaceWith(rawFieldTag);\n            });\n\n            editor.setContent(div.innerHTML);\n        });\n    }\n}\n\nexport const init = (options) => {\n    const patterndialogue = new PatternDialogue(options);\n    patterndialogue.init();\n};\n"],"names":["PatternDialogue","constructor","options","dialogInstances","Map","init","console","log","this","document","addEventListener","waitForTinyMCE","dropdownMenu","getElementById","insertTagFromDropdown","form","querySelector","e","convertButtonsToTagsBeforeSubmit","replaceTagsWithButtons","editor","div","createElement","innerHTML","getContent","replace","_","action","field","behavior","renderer","setContent","reInitializeButtons","dataid","getBody","querySelectorAll","forEach","button","getAttribute","openMoodleDialog","setAttribute","initializeTinyMCEButtons","window","tinyMCE","_window$tinyMCE","get","on","isFieldTag","classList","contains","dialogContent","id","textContent","delBtn","remove","dialog","hide","M","core","dialogue","bodyContent","width","draggable","modal","visible","set","activeEditor","length","initReplaceTagsWithButtons","setTimeout","dropdown","selectedValue","value","actionTagMatch","match","fieldTagMatch","contentToInsert","insertContent","replaceWith","_button$getAttribute","trim","rawFieldTag"],"mappings":"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"}