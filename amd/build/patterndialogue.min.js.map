{"version":3,"file":"patterndialogue.min.js","sources":["../src/patterndialogue.js"],"sourcesContent":["/* eslint-disable no-unused-vars */\n// This file is part of Moodle - http:// Moodle.org/.\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Function to replace ##value## or [[field|behavior|renderer]] tags with buttons\n * @param {*} editor - The TinyMCE editor instance\n */\nfunction replaceTagsWithButtons(editor) {\n    const content = editor.getContent();\n\n    const div = document.createElement('div');\n    div.innerHTML = content;\n\n    div.innerHTML = div.innerHTML.replace(/##([^#]+)##/g, (match, action) => {\n        return `<button type=\"button\" contenteditable=\"false\" data-action-tag-button=\"true\"\n        data-datalynx-field=\"${action}\">${action}</button>`;\n    });\n\n    div.innerHTML = div.innerHTML.replace(/\\[\\[([^\\|\\]]+)(?:\\|([^\\|\\]]*))?(?:\\|([^\\|\\]]*))?\\]\\]/g,\n        (match, field, behavior, renderer) => {\n        behavior = behavior || '';\n        renderer = renderer || '';\n        return `<button type=\"button\" contenteditable=\"false\" class=\"datalynx-field-tag\" data-datalynx-field=\"\n        ${field}\" data-datalynx-behavior=\"${behavior}\" data-datalynx-renderer=\"${renderer}\">${field}</button>`;\n    });\n\n    editor.setContent(div.innerHTML);\n}\n\n/**\n * Reinitialize buttons to attach event listeners\n * @param {*} editor - The TinyMCE editor instance\n */\nfunction reInitializeButtons(editor) {\n    let dataid = 0;\n    editor.getBody().querySelectorAll('button[data-action-tag-button=\"true\"], button.datalynx-field-tag').forEach((button) => {\n        if (!button.getAttribute('data-click-initialized')) {\n            button.addEventListener('click', () => openMoodleDialog(button));\n            button.setAttribute('data-click-initialized', 'true');\n            button.setAttribute('data-id', 'datalynx-buton-id-' + dataid);\n        }\n    });\n}\n\n/**\n * Initialize buttons in TinyMCE after the editor is ready\n */\nfunction initializeTinyMCEButtons() {\n    if (window.tinyMCE?.get) {\n        window.tinyMCE.get().forEach((editor) => {\n            editor.on('init', () => reInitializeButtons(editor));\n            editor.on('SetContent', () => reInitializeButtons(editor));\n            editor.on('change', () => reInitializeButtons(editor));\n        });\n    } else {\n        setTimeout(initializeTinyMCEButtons, 100);\n    }\n}\n\n/**\n * Open Moodle dialog for tags (action or field)\n * @param {*} button - The button element clicked\n */\nfunction openMoodleDialog(button) {\n    const isFieldTag = button.classList.contains('datalynx-field-tag');\n    const dialogContent = document.createElement('div');\n    dialogContent.setAttribute('id', button.getAttribute('data-id'));\n\n    if (isFieldTag) {\n        dialogContent.innerHTML = `\n            <p>Field tag properties:</p>\n            <p>Field: ${button.textContent}</p>\n            <label>Behavior:</label>\n            <select id=\"tag-behavior-select-${dialogContent.id}\">\n                <option value=\"behavior1\">Behavior 1</option>\n                <option value=\"behavior2\">Behavior 2</option>\n            </select>\n            <label>Renderer:</label>\n            <select id=\"tag-renderer-select-${dialogContent.id}\">\n                <option value=\"renderer1\">Renderer 1</option>\n                <option value=\"renderer2\">Renderer 2</option>\n            </select>\n            <button type=\"button\" class=\"delete-tag\">Delete tag</button>\n        `;\n\n        // document.getElementById('tag-behavior-select-' + dialogContent.id).value = button.getAttribute('data-datalynx-behavior');\n        // document.getElementById('tag-renderer-select-' + dialogContent.id).value = button.getAttribute('data-datalynx-renderer');\n    } else {\n        dialogContent.innerHTML = `\n            <p>Action tag properties:</p>\n            <p>Action: ${button.textContent}</p>\n            <button type=\"button\" class=\"delete-tag\">Delete tag</button>\n        `;\n    }\n\n    dialogContent.querySelectorAll('.delete-tag').forEach((deleteButton) => {\n        deleteButton.addEventListener('click', () => {\n            button.remove();\n            dialog.hide();\n        });\n    });\n\n    const dialog = new M.core.dialogue({\n        bodyContent: dialogContent,\n        width: '400px',\n        draggable: true,\n        modal: true,\n        visible: true,\n        footerContent: ''\n    });\n}\n\n/**\n * Initialize the replacement of tags with buttons because get() does not work without a method\n */\nfunction initReplaceTagsWithButtons() {\n    window.tinyMCE.get().forEach((editor) => {\n        // Replace tags with buttons when the editor is initialized\n        editor.on('init', () => replaceTagsWithButtons(editor));\n        // Reinitialize buttons after content is loaded or changed\n        editor.on('SetContent', () => reInitializeButtons(editor));\n        editor.on('change', () => reInitializeButtons(editor));\n    });\n}\n\n/**\n * Wait for TinyMCE to be fully ready before initializing\n */\nfunction waitForTinyMCE() {\n    if (window.tinyMCE?.activeEditor && window.tinyMCE.get().length > 0) {\n        initReplaceTagsWithButtons();\n        initializeTinyMCEButtons();\n    } else {\n        setTimeout(waitForTinyMCE, 100);\n    }\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n    const dropdownMenu = document.getElementById('eparam2_editor_field_tag_menu');\n\n    if (typeof tinymce !== 'undefined') {\n        waitForTinyMCE();\n    } else {\n        document.addEventListener('tinymce-editor-init', waitForTinyMCE);\n    }\n\n    if (dropdownMenu) {\n        dropdownMenu.addEventListener('change', () => {\n            const selectedValue = dropdownMenu.value;\n\n            const actionTagMatch = selectedValue.match(/^##(.+?)##$/);\n            const fieldTagMatch = selectedValue.match(/^\\[\\[([^\\|\\]]+)(?:\\|([^\\|\\]]*))?(?:\\|([^\\|\\]]*))?\\]\\]$/);\n\n            let contentToInsert = '';\n\n            if (actionTagMatch) {\n                contentToInsert = `<button type=\"button\" contenteditable=\"false\" class=\"action-tag-button\"\n                data-action-tag-button=\"true\" data-datalynx-field=\"${actionTagMatch[1]}\">${actionTagMatch[1]}</button>`;\n            } else if (fieldTagMatch) {\n                const field = fieldTagMatch[1];\n                const behavior = fieldTagMatch[2] || '';\n                const renderer = fieldTagMatch[3] || '';\n                contentToInsert = `<button type=\"button\" contenteditable=\"false\" class=\"datalynx-field-tag\" \n                data-datalynx-field=\"${field}\" data-datalynx-behavior=\"${behavior}\" \n                data-datalynx-renderer=\"${renderer}\">${field}</button>`;\n            } else {\n                contentToInsert = selectedValue;\n            }\n\n            window.tinyMCE.get().forEach((editor) => {\n                if (editor.id === \"id_eparam2_editor\") {\n                    editor.insertContent(contentToInsert);\n                    reInitializeButtons(editor);\n                }\n            });\n        });\n    }\n\n    const form = document.querySelector('#datalynx-view-edit-form');\n    form.addEventListener('submit', (event) => {\n        window.tinyMCE.get().forEach((editor) => {\n            const content = editor.getContent();\n            const div = document.createElement('div');\n            div.innerHTML = content;\n\n            div.querySelectorAll('button[data-action-tag-button=\"true\"]').forEach((button) => {\n                const action = button.getAttribute('data-datalynx-field');\n                button.replaceWith(`##${action}##`);\n            });\n\n            div.querySelectorAll('button.datalynx-field-tag').forEach((button) => {\n                const field = button.getAttribute('data-datalynx-field').trim();\n                const behavior = button.getAttribute('data-datalynx-behavior') || '';\n                const renderer = button.getAttribute('data-datalynx-renderer') || '';\n                const rawFieldTag = `[[${field}${behavior ? '|' + behavior : ''}${renderer ? '|' + renderer : ''}]]`;\n                button.replaceWith(rawFieldTag);\n            });\n\n            editor.setContent(div.innerHTML);\n        });\n    });\n});\n\nwaitForTinyMCE();\n"],"names":["reInitializeButtons","editor","getBody","querySelectorAll","forEach","button","getAttribute","addEventListener","isFieldTag","classList","contains","dialogContent","document","createElement","setAttribute","innerHTML","textContent","id","deleteButton","remove","dialog","hide","M","core","dialogue","bodyContent","width","draggable","modal","visible","footerContent","openMoodleDialog","initializeTinyMCEButtons","window","tinyMCE","_window$tinyMCE","get","on","setTimeout","initReplaceTagsWithButtons","content","getContent","div","replace","match","action","field","behavior","renderer","setContent","replaceTagsWithButtons","waitForTinyMCE","activeEditor","length","dropdownMenu","getElementById","tinymce","selectedValue","value","actionTagMatch","fieldTagMatch","contentToInsert","insertContent","querySelector","event","replaceWith","trim","rawFieldTag"],"mappings":"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"}