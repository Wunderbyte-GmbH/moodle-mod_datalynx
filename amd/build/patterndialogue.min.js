define("mod_datalynx/patterndialogue",["exports","core/str"],(function(_exports,Str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}
/**
   * @module     mod_datalynx/patterndialogue
   * @copyright  2025 Wunderbyte GmbH
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */(Str);class PatternDialogue{constructor(options){this.options=options,this.dialogInstances=new Map}init(){console.log(this.options),document.addEventListener("DOMContentLoaded",(()=>{this.waitForTinyMCE();const dropdownMenu=document.getElementById("eparam2_editor_field_tag_menu");dropdownMenu&&dropdownMenu.addEventListener("change",(()=>this.insertTagFromDropdown(dropdownMenu)));const form=document.querySelector("#datalynx-view-edit-form");null==form||form.addEventListener("submit",(e=>this.convertButtonsToTagsBeforeSubmit()))}))}replaceTagsWithButtons(editor){const div=document.createElement("div");div.innerHTML=editor.getContent(),div.innerHTML=div.innerHTML.replace(/##([^#]+)##/g,((_,action)=>'<button type="button" contenteditable="false" data-action-tag-button="true"\n                data-datalynx-field="'.concat(action,'">').concat(action,"</button>"))).replace(/\[\[([^\|\]]+)(?:\|([^\|\]]*))?(?:\|([^\|\]]*))?\]\]/g,(function(_,field){let behavior=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",renderer=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return'<button type="button" contenteditable="false" class="datalynx-field-tag"\n                data-datalynx-field="'.concat(field,'" data-datalynx-behavior="').concat(behavior,'"\n                data-datalynx-renderer="').concat(renderer,'">').concat(field,"</button>")})),editor.setContent(div.innerHTML)}reInitializeButtons(editor){let dataid=0;editor.getBody().querySelectorAll("button[data-action-tag-button], button.datalynx-field-tag").forEach((button=>{button.getAttribute("data-click-initialized")||(button.addEventListener("click",(()=>this.openMoodleDialog(button))),button.setAttribute("data-click-initialized","true"),button.setAttribute("data-id","datalynx-button-id-".concat(dataid++)))}))}initializeTinyMCEButtons(){var _window$tinyMCE;null!==(_window$tinyMCE=window.tinyMCE)&&void 0!==_window$tinyMCE&&_window$tinyMCE.get&&window.tinyMCE.get().forEach((editor=>{editor.on("init",(()=>this.reInitializeButtons(editor))),editor.on("SetContent",(()=>this.reInitializeButtons(editor))),editor.on("change",(()=>this.reInitializeButtons(editor)))}))}openMoodleDialog(button){const isFieldTag=button.classList.contains("datalynx-field-tag"),dialogContent=document.createElement("div");dialogContent.id=button.getAttribute("data-id"),dialogContent.innerHTML=isFieldTag?"\n                <p>Field tag properties:</p>\n                <p>Field: ".concat(button.textContent,'</p>\n                <label>Behavior:</label>\n                <select id="tag-behavior-select-').concat(dialogContent.id,'">\n                    <option value="behavior1">Behavior 1</option>\n                    <option value="behavior2">Behavior 2</option>\n                </select>\n                <label>Renderer:</label>\n                <select id="tag-renderer-select-').concat(dialogContent.id,'">\n                    <option value="renderer1">Renderer 1</option>\n                    <option value="renderer2">Renderer 2</option>\n                </select>\n                <button type="button" class="delete-tag">Delete tag</button>\n            '):"\n                <p>Action tag properties:</p>\n                <p>Action: ".concat(button.textContent,'</p>\n                <button type="button" class="delete-tag">Delete tag</button>\n            '),dialogContent.querySelectorAll(".delete-tag").forEach((delBtn=>delBtn.addEventListener("click",(()=>{button.remove(),null==dialog||dialog.hide()}))));const dialog=new M.core.dialogue({bodyContent:dialogContent,width:"400px",draggable:!0,modal:!0,visible:!0});this.dialogInstances.set(dialogContent.id,dialog)}waitForTinyMCE(){var _window$tinyMCE2;null!==(_window$tinyMCE2=window.tinyMCE)&&void 0!==_window$tinyMCE2&&_window$tinyMCE2.activeEditor&&window.tinyMCE.get().length>0?(this.initReplaceTagsWithButtons(),this.initializeTinyMCEButtons()):setTimeout((()=>this.waitForTinyMCE()),100)}initReplaceTagsWithButtons(){window.tinyMCE.get().forEach((editor=>{editor.on("init",(()=>this.replaceTagsWithButtons(editor))),editor.on("SetContent",(()=>this.reInitializeButtons(editor))),editor.on("change",(()=>this.reInitializeButtons(editor)))}))}insertTagFromDropdown(dropdown){const selectedValue=dropdown.value,actionTagMatch=selectedValue.match(/^##(.+?)##$/),fieldTagMatch=selectedValue.match(/^\[\[([^\|\]]+)(?:\|([^\|\]]*))?(?:\|([^\|\]]*))?\]\]$/);let contentToInsert="";if(actionTagMatch)contentToInsert='<button type="button" contenteditable="false" class="action-tag-button"\n                data-action-tag-button="true" data-datalynx-field="'.concat(actionTagMatch[1],'">').concat(actionTagMatch[1],"</button>");else if(fieldTagMatch){const field=fieldTagMatch[1],behavior=fieldTagMatch[2]||"",renderer=fieldTagMatch[3]||"";contentToInsert='<button type="button" contenteditable="false" class="datalynx-field-tag"\n                data-datalynx-field="'.concat(field,'" data-datalynx-behavior="').concat(behavior,'"\n                data-datalynx-renderer="').concat(renderer,'">').concat(field,"</button>")}else contentToInsert=selectedValue;window.tinyMCE.get().forEach((editor=>{"id_eparam2_editor"===editor.id&&(editor.insertContent(contentToInsert),this.reInitializeButtons(editor))}))}convertButtonsToTagsBeforeSubmit(){window.tinyMCE.get().forEach((editor=>{const div=document.createElement("div");div.innerHTML=editor.getContent(),div.querySelectorAll("button[data-action-tag-button]").forEach((button=>{button.replaceWith("##".concat(button.getAttribute("data-datalynx-field"),"##"))})),div.querySelectorAll("button.datalynx-field-tag").forEach((button=>{var _button$getAttribute;const field=null===(_button$getAttribute=button.getAttribute("data-datalynx-field"))||void 0===_button$getAttribute?void 0:_button$getAttribute.trim(),behavior=button.getAttribute("data-datalynx-behavior")||"",renderer=button.getAttribute("data-datalynx-renderer")||"",rawFieldTag="[[".concat(field).concat(behavior?"|"+behavior:"").concat(renderer?"|"+renderer:"","]]");button.replaceWith(rawFieldTag)})),editor.setContent(div.innerHTML)}))}}_exports.init=options=>{new PatternDialogue(options).init()}}));

//# sourceMappingURL=patterndialogue.min.js.map