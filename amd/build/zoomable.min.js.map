{"version":3,"file":"zoomable.min.js","sources":["../src/zoomable.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/.\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module mod_datalynx/zoomable\n * @copyright 2017 Thomas Niedermaier (thomas.niedermaier@gmail.com)\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Create new dayslots as duplicates of the seven original day slots\n */\n\n\ndefine([], () => {\n    /**\n     * @constructor\n     * @alias module:mod_datalynx/zoomable\n     */\n    class Zoomable {\n        constructor() {\n            this.instances = [];\n            this.effects = {};\n        }\n\n        init() {\n            if (!window.tools) {\n                window.tools = { version: '@VERSION' };\n            }\n\n            window.tools.overlay = {\n                addEffect: (name, loadFn, closeFn) => {\n                    this.effects[name] = [loadFn, closeFn];\n                },\n                conf: {\n                    close: null,\n                    closeOnClick: true,\n                    closeOnEsc: true,\n                    closeSpeed: 'fast',\n                    effect: 'default',\n                    fixed: !/msie/.test(navigator.userAgent.toLowerCase()) || navigator.appVersion > 6,\n                    left: 'center',\n                    load: false,\n                    mask: null,\n                    oneInstance: true,\n                    speed: 'normal',\n                    target: null,\n                    top: '10%',\n                },\n            };\n\n            window.tools.overlay.addEffect('default', function (pos, onLoad) {\n                const conf = this.getConf();\n                const scrollTop = window.scrollY || document.documentElement.scrollTop;\n                const scrollLeft = window.scrollX || document.documentElement.scrollLeft;\n\n                if (!conf.fixed) {\n                    pos.top += scrollTop;\n                    pos.left += scrollLeft;\n                }\n                pos.position = conf.fixed ? 'fixed' : 'absolute';\n                this.getOverlay().style.position = pos.position;\n                this.getOverlay().style.top = `${pos.top}px`;\n                this.getOverlay().style.left = `${pos.left}px`;\n                this.getOverlay().style.display = 'block';\n                setTimeout(onLoad, conf.speed === 'fast' ? 200 : 400); // Mocking fade-in timing\n            }, function (onClose) {\n                const overlay = this.getOverlay();\n                overlay.style.display = 'none';\n                setTimeout(onClose, this.getConf().closeSpeed === 'fast' ? 200 : 400); // Mocking fade-out timing\n            });\n        }\n\n        Overlay(trigger, conf) {\n            const self = this;\n            const fireEvent = (type, detail) => {\n                trigger.dispatchEvent(new CustomEvent(type, { detail }));\n            };\n\n            let overlay = conf.target || document.querySelector(trigger.getAttribute(\"rel\")) || trigger;\n            let opened = false;\n\n            if (!overlay) {\n                throw new Error(`Could not find Overlay: ${conf.target || trigger.getAttribute('rel')}`);\n            }\n\n            trigger.addEventListener('click', (e) => {\n                e.preventDefault();\n                self.load(e);\n            });\n\n            Object.assign(self, {\n                load(e = new Event('load')) {\n                    if (self.isOpened()) {\n                        return self;\n                    }\n                    const eff = this.effects[conf.effect];\n                    if (!eff) {\n                        throw new Error(`Overlay: cannot find effect: \"${conf.effect}\"`);\n                    }\n                    if (conf.oneInstance) {\n                        this.instances.forEach((instance) => {\n                            instance.close(e);\n                        });\n                    }\n\n                    fireEvent('onBeforeLoad', e);\n                    if (e.defaultPrevented) {\n                        return self;\n                    }\n\n                    opened = true;\n\n                    const windowHeight = window.innerHeight;\n                    const windowWidth = window.innerWidth;\n                    const overlayRect = overlay.getBoundingClientRect();\n                    let top = conf.top === 'center' ?\n                        Math.max((windowHeight - overlayRect.height) / 2, 0) : parseInt(conf.top, 10);\n                    let left = conf.left === 'center' ?\n                        Math.max((windowWidth - overlayRect.width) / 2, 0) : parseInt(conf.left, 10);\n\n                    eff[0].call(self, { top, left }, () => {\n                        if (opened) {\n                            fireEvent('onLoad', e);\n                        }\n                    });\n\n                    if (conf.closeOnClick) {\n                        document.addEventListener('click', (ev) => {\n                            if (!overlay.contains(ev.target)) {\n                                self.close(ev);\n                            }\n                        });\n                    }\n\n                    if (conf.closeOnEsc) {\n                        document.addEventListener('keydown', (ev) => {\n                            if (ev.key === 'Escape') {\n                                self.close(ev);\n                            }\n                        });\n                    }\n\n                    return self;\n                },\n\n                close(e = new Event('close')) {\n                    if (!self.isOpened()) {\n                        return self;\n                    }\n\n                    fireEvent('onBeforeClose', e);\n                    if (e.defaultPrevented) {\n                        return;\n                    }\n\n                    opened = false;\n                    this.effects[conf.effect][1].call(self, () => {\n                        fireEvent('onClose', e);\n                    });\n\n                    return self;\n                },\n\n                getOverlay() {\n                    return overlay;\n                },\n\n                isOpened() {\n                    return opened;\n                },\n\n                getConf() {\n                    return conf;\n                }\n            });\n\n            const closers = overlay.querySelectorAll(conf.close || '.close');\n            closers.forEach((closer) => {\n                closer.addEventListener('click', (e) => {\n                    self.close(e);\n                });\n            });\n\n            if (conf.load) {\n                self.load();\n            }\n        }\n\n        static writeNewOverlay(trigger) {\n            let divname = `zoomable${Zoomable.index}`;\n            Zoomable.index += 1;\n\n            const img = document.createElement('img');\n            img.src = trigger.src;\n\n            img.onload = function () {\n                let { width, height } = img;\n                const windowHeight = window.innerHeight - 60;\n                const windowWidth = window.innerWidth - 60;\n\n                if (height > windowHeight) {\n                    width = Math.round(windowHeight * width / height);\n                    height = windowHeight;\n                }\n\n                if (width > windowWidth) {\n                    height = Math.round(windowWidth * height / width);\n                    width = windowWidth;\n                }\n\n                const overlayDiv = document.createElement('div');\n                overlayDiv.id = divname;\n                overlayDiv.className = 'm3e-overlay';\n\n                const closeButton = document.createElement('div');\n                closeButton.className = 'close m3e-closebutton';\n                overlayDiv.appendChild(closeButton);\n\n                const imgElement = document.createElement('img');\n                imgElement.src = trigger.src;\n                imgElement.width = width;\n                imgElement.height = height;\n                imgElement.className = 'close';\n                overlayDiv.appendChild(imgElement);\n\n                document.body.appendChild(overlayDiv);\n\n                trigger.setAttribute('rel', `#${divname}`);\n                new Zoomable().Overlay(trigger, { load: true, top: 'center' });\n            };\n        }\n    }\n\n    Zoomable.index = 0;\n\n    document.addEventListener('DOMContentLoaded', () => {\n        const zoomableImages = document.querySelectorAll('img.zoomable');\n        zoomableImages.forEach((img) => {\n            img.setAttribute('title', 'Zum Vergrößern klicken');\n            img.addEventListener('click', () => {\n                if (img.getAttribute('rel')) {\n                    const overlay = document.querySelector(img.getAttribute('rel'));\n                    if (overlay) {\n                        img.removeAttribute('rel');\n                        overlay.remove();\n                    }\n                }\n                Zoomable.writeNewOverlay(img);\n            });\n        });\n\n        window.addEventListener('resize', () => {\n            document.querySelectorAll('[rel]').forEach((el) => {\n                const api = el.dataset.overlay;\n                if (api && api.isOpened()) {\n                    const overlay = document.querySelector(el.getAttribute('rel'));\n                    if (overlay) {\n                        el.removeAttribute('rel');\n                        overlay.remove();\n                        Zoomable.writeNewOverlay(el);\n                    }\n                }\n            });\n        });\n    });\n\n    return new Zoomable();\n});\n"],"names":["define","Zoomable","constructor","instances","effects","init","window","tools","version","overlay","addEffect","name","loadFn","closeFn","conf","close","closeOnClick","closeOnEsc","closeSpeed","effect","fixed","test","navigator","userAgent","toLowerCase","appVersion","left","load","mask","oneInstance","speed","target","top","pos","onLoad","this","getConf","scrollTop","scrollY","document","documentElement","scrollLeft","scrollX","position","getOverlay","style","display","setTimeout","onClose","Overlay","trigger","self","fireEvent","type","detail","dispatchEvent","CustomEvent","querySelector","getAttribute","opened","Error","addEventListener","e","preventDefault","Object","assign","Event","isOpened","eff","forEach","instance","defaultPrevented","windowHeight","innerHeight","windowWidth","innerWidth","overlayRect","getBoundingClientRect","Math","max","height","parseInt","width","call","ev","contains","key","querySelectorAll","closer","divname","index","img","createElement","src","onload","round","overlayDiv","id","className","closeButton","appendChild","imgElement","body","setAttribute","removeAttribute","remove","writeNewOverlay","el","api","dataset"],"mappings":"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"}